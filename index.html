<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Selamat Ulang Tahun 🎉</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r167/three.min.js" 
          onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.min.js'; alert('CDN THREE.js gagal! Cek koneksi internet atau coba browser lain.');"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r167/examples/js/controls/OrbitControls.min.js" 
          onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/controls/OrbitControls.min.js'; alert('CDN OrbitControls gagal! Cek koneksi internet atau coba browser lain.');"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: linear-gradient(to bottom right, #ffdde1, #ee9ca7); overflow: hidden; }
    .halaman { display: flex; justify-content: center; align-items: center; flex-direction: column; height: 100vh; text-align: center; }
    .sembunyi { display: none; }
    button { margin: 0.3rem; padding: 0.6rem 1.2rem; font-size: 0.9em; background: #e94e77; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #d03e6e; }
    .stiker { margin-top: 1rem; font-size: 2rem; }
    .kotakTeks { margin-top: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.3); border-radius: 8px; }
    #halamanPermainan { position: relative; height: 100vh; }
    canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
    #toggleMusic, #tambahDekorasi { position: fixed; top: 10px; z-index: 100; }
    #tambahDekorasi { right: 10px; }
    #panelDekorasi {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
      width: 250px; max-height: 80vh; background: rgba(255,255,255,0.95); padding: 15px;
      border: 2px solid #ff5555; border-radius: 12px; z-index: 90; overflow-y: auto;
      opacity: 0; transition: opacity 0.3s, transform 0.3s;
    }
    #panelDekorasi.open { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .tab-menu { display: flex; flex-wrap: nowrap; justify-content: space-between; }
    .tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; background: #f0f0f0; margin: 0 2px; border-radius: 4px; font-size: 0.8em; }
    .tab.active { background: #ff69b4; color: white; }
    .tab-content { display: none; padding: 10px 0; }
    .tab-content.active { display: flex; flex-wrap: wrap; gap: 8px; }
    select, input[type="color"] { width: 50px; height: 30px; border: 2px solid #ff5555; }
    input[type="range"] { width: 100px; }
    #instruksiPopup, #detailPopup, #pesanPopup {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #ffb6c1; padding: 1rem; border: 2px solid #ff5555; border-radius: 8px; z-index: 110;
    }
    #detailPopup, #pesanPopup { display: none; }
  </style>
</head>
<body>
  <audio id="bgMusic" loop>
    <source src="https://cdn.pixabay.com/download/audio/2023/03/23/audio_4a5e39912b.mp3" type="audio/mpeg">
  </audio>
  <div class="halaman" id="halaman1">
    <h1>Hai Umai 😌</h1>
    <p>Maaf ya aku belum bisa ngasih apa-apa, jadi sementara ini dulu ya..</p>
    <div class="stiker">🎁🎈💖</div>
    <div class="kotakTeks">Hari ini hari spesial kamu 🎉</div>
    <button id="tombolLanjut1">Lanjut</button>
  </div>
  <div class="halaman sembunyi" id="halaman2">
    <h1>Selamat Ulang Tahun 🎂</h1>
    <p>Semoga panjang umur, sehat selalu, dan makin bahagia! 🌸</p>
    <div class="stiker">🎊🎂🥳</div>
    <div class="kotakTeks">Jangan lupa senyum hari ini ya 😄</div>
    <button id="tombolLanjut2">Lanjut 🎉</button>
  </div>
  <div class="halaman sembunyi" id="halaman3">
    <h1>Ucapan Spesial 🎉</h1>
    <p>Kalau kamu baca ini... berarti kamu orang yang spesial banget buatku 💌</p>
    <p>Happy Birthday sekali lagi ya Umai 💖</p>
    <div class="stiker">✨💝🎇</div>
    <div class="kotakTeks">Terima kasih sudah lahir ke dunia ini 💕</div>
    <button id="tombolMulai">Dekorasi Kue 🍰</button>
  </div>
  <div id="halamanPermainan" class="sembunyi">
    <canvas id="kanvasPermainan"></canvas>
    <button id="toggleMusic">🔊</button>
    <button id="tambahDekorasi">🎨</button>
    <div id="panelDekorasi" class="sembunyi">
      <div class="tab-menu">
        <div class="tab active" data-tab="kue">Kue</div>
        <div class="tab" data-tab="topping">Topping</div>
        <div class="tab" data-tab="lilin">Lilin</div>
        <div class="tab" data-tab="cairan">Cairan</div>
        <div class="tab" data-tab="teks">Teks</div>
      </div>
      <div class="tab-content active" id="tab-kue">
        <button id="buatKue">Buat Kue</button>
        <button id="hapusKue">Hapus Kue</button>
        <select id="bentukKue">
          <option value="bulat">Bulat</option>
          <option value="kotak">Kotak</option>
          <option value="oval">Oval</option>
          <option value="hati">Hati</option>
        </select>
        <select id="ukuranKue">
          <option value="kecil">Kecil</option>
          <option value="sedang">Sedang</option>
          <option value="besar">Besar</option>
        </select>
        <select id="teksturKue">
          <option value="cokelat">Cokelat</option>
          <option value="vanila">Vanila</option>
          <option value="strawberi">Strawberi</option>
        </select>
        <input type="color" id="warnaKue" value="#5c4033" />
        <input type="color" id="warnaGlaze" value="#ffffff" />
      </div>
      <div class="tab-content" id="tab-topping">
        <button id="taburanSprinkle">Sprinkle</button>
        <button id="taburanChip">Cokelat Chip</button>
        <button id="taburanBunga">Bunga</button>
        <button id="taburanBuah">Buah</button>
        <button id="taburanKrim">Krim</button>
        <input type="color" id="warnaTopping" value="#ff5555" />
        <input type="range" id="skalaTopping" min="0.5" max="2" step="0.1" value="1" />
      </div>
      <div class="tab-content" id="tab-lilin">
        <button id="lilin">Tambah Lilin</button>
        <input type="color" id="warnaLilin" value="#ff5555" />
        <input type="range" id="skalaLilin" min="0.5" max="2" step="0.1" value="1" />
      </div>
      <div class="tab-content" id="tab-cairan">
        <button id="cairan">Tambah Cairan</button>
        <input type="color" id="warnaCairan" value="#ff5555" />
        <input type="range" id="intensitasCairan" min="0.1" max="1" step="0.1" value="0.5" />
      </div>
      <div class="tab-content" id="tab-teks">
        <button id="tambahTeks">Tambah Teks</button>
        <button id="tambahEmoticon">Tambah Emoticon</button>
        <button id="pindahObjek">Pindah Objek</button>
        <button id="hapusObjek">Hapus Objek</button>
        <button id="simpanKue">Simpan Kue</button>
        <button id="loadKue">Load Kue</button>
        <button id="selesai">Selesai</button>
      </div>
    </div>
    <div id="instruksiPopup">
      <h2>🎂 Dekorasi Kue 3D 🎉</h2>
      <p>Buat kue ultah keren untuk Umai!</p>
      <p>Klik "Buat Kue" untuk mulai, drag untuk putar kamera, klik topping untuk tambah.</p>
      <button id="tombolMulaiGame">Mulai</button>
    </div>
    <div id="detailPopup">
      <h2>Detail Kue Kamu 🎂</h2>
      <p id="detailText"></p>
      <button id="tombolLanjutDetail">Lanjut</button>
      <button id="tombolUlang">Coba Lagi</button>
    </div>
    <div id="pesanPopup">
      <h2>Pesan Spesial 💖</h2>
      <p>Semoga kue ini bikin harimu makin manis, Umai! 🥰</p>
      <p>Happy Birthday sekali lagi! 🎉</p>
      <button id="tombolUlang">Main Lagi</button>
    </div>
  </div>
  <script>
    // Cek koneksi dan THREE.js
    if (!navigator.onLine) {
      alert('Kamu offline! CDN THREE.js butuh internet. Pastikan koneksi aktif atau coba versi dengan file lokal.');
      throw new Error('Offline mode detected');
    }
    if (typeof THREE === 'undefined') {
      alert('THREE.js gagal load! Cek koneksi internet atau coba browser lain.');
      throw new Error('THREE.js not loaded');
    }

    let scene, camera, renderer, controls, kueList = [], selectedKue = null, dekorasiTerpilih = null;
    let isMoving = false, isDragging = false, permainanSelesai = false;
    let warnaTopping = 0xff5555, skalaTopping = 1, warnaLilin = 0xff5555, skalaLilin = 1;
    let warnaCairan = 0xff5555, intensitasCairan = 0.5;
    let isMusicPlaying = false;

    function setupScene() {
      try {
        console.log('Starting scene setup...');
        const canvas = document.getElementById('kanvasPermainan');
        if (!canvas) throw new Error('Canvas element not found');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setClearColor(0x000000, 0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        camera.position.set(0, 1, 2);
        camera.lookAt(0, 0, 0);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const spotLight = new THREE.SpotLight(0xffffff, 1.2);
        spotLight.position.set(2, 2, 2);
        scene.add(spotLight);
        scene.add(new THREE.AxesHelper(1));
        console.log('Scene setup completed');
      } catch (e) {
        console.error('Scene setup error:', e);
        alert('Gagal setup scene! Cek Console (F12) untuk detail.');
      }
    }

    function createKueTexture(tipe = 'cokelat') {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = 64;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = tipe === 'cokelat' ? '#5c4033' : tipe === 'vanila' ? '#f3e5ab' : '#a2231d';
        ctx.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(canvas);
      } catch (e) {
        console.error('Create texture error:', e);
        return null;
      }
    }

    function createBumpMap(tipe) {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = 64;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, 64, 64);
        ctx.fillStyle = '#aaaaaa';
        for (let i = 0; i < 50; i++) {
          ctx.beginPath();
          ctx.arc(Math.random() * 64, Math.random() * 64, Math.random() * 2, 0, Math.PI * 2);
          ctx.fill();
        }
        return new THREE.CanvasTexture(canvas);
      } catch (e) {
        console.error('Create bump map error:', e);
        return null;
      }
    }

    function createFlameTexture() {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = 32;
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        gradient.addColorStop(0, 'rgba(255, 165, 0, 1)');
        gradient.addColorStop(0.5, 'rgba(255, 69, 0, 0.5)');
        gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 32, 32);
        return new THREE.CanvasTexture(canvas);
      } catch (e) {
        console.error('Create flame texture error:', e);
        return null;
      }
    }

    function createLiquidShader() {
      if (!THREE) {
        console.error('THREE.js not available');
        return null;
      }
      try {
        return new THREE.ShaderMaterial({
          uniforms: {
            time: { value: 0 },
            color: { value: new THREE.Color(0xff5555) },
            intensity: { value: 0.5 }
          },
          vertexShader: `
            varying vec2 vUv;
            void main() {
              vUv = uv;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,
          fragmentShader: `
            uniform float time;
            uniform vec3 color;
            uniform float intensity;
            varying vec2 vUv;
            void main() {
              vec2 p = vUv * 2.0 - 1.0;
              float d = length(p);
              float t = sin(time + d * 10.0) * intensity;
              gl_FragColor = vec4(color * (1.0 - d + t), 0.5);
            }
          `,
          transparent: true
        });
      } catch (e) {
        console.error('Create liquid shader error:', e);
        return null;
      }
    }

    function createKue(bentuk, ukuran, tekstur, warna) {
      if (!THREE) {
        console.error('THREE.js not available');
        return;
      }
      try {
        console.log(`Membuat kue: ${bentuk}, ukuran: ${ukuran}, tekstur: ${tekstur}, warna: ${warna.toString(16)}`);
        const kueData = {
          group: new THREE.Group(),
          bentuk: bentuk,
          warnaKue: warna,
          warnaGlaze: 0xffffff,
          teksturKue: tekstur,
          topping: [],
          lilin: [],
          cairan: [],
          teks: [],
          emoticon: []
        };
        let geo, scale;
        if (bentuk === 'kotak') {
          geo = new THREE.BoxGeometry(0.8, 0.3, 0.8);
          scale = ukuran === 'kecil' ? 0.6 : ukuran === 'besar' ? 1.2 : 0.8;
        } else if (bentuk === 'bulat') {
          geo = new THREE.CylinderGeometry(0.5, 0.5, 0.3, 32);
          scale = ukuran === 'kecil' ? 0.6 : ukuran === 'besar' ? 1.2 : 0.8;
        } else if (bentuk === 'oval') {
          const shape = new THREE.Shape();
          shape.absarc(0, 0, 0.5, 0, Math.PI * 2);
          geo = new THREE.ExtrudeGeometry(shape, { depth: 0.3, bevelEnabled: false });
          scale = ukuran === 'kecil' ? 0.6 : ukuran === 'besar' ? 1.2 : 0.8;
        } else if (bentuk === 'hati') {
          const shape = new THREE.Shape();
          shape.moveTo(0, 0.1);
          shape.bezierCurveTo(0, 0.2, -0.1, 0.3, -0.2, 0.3);
          shape.bezierCurveTo(-0.3, 0.3, -0.3, 0.1, -0.3, 0);
          shape.bezierCurveTo(-0.3, -0.2, -0.1, -0.3, 0, -0.3);
          shape.bezierCurveTo(0.1, -0.3, 0.3, -0.2, 0.3, 0);
          shape.bezierCurveTo(0.3, 0.1, 0.2, 0.3, 0.1, 0.3);
          shape.bezierCurveTo(0, 0.3, 0, 0.2, 0, 0.1);
          geo = new THREE.ExtrudeGeometry(shape, { depth: 0.3, bevelEnabled: false });
          scale = ukuran === 'kecil' ? 0.6 : ukuran === 'besar' ? 1.2 : 0.8;
        }
        const mat = new THREE.MeshPhongMaterial({
          color: warna,
          map: createKueTexture(tekstur),
          bumpMap: createBumpMap(tekstur),
          specular: 0x222222,
          shininess: 30
        });
        const kue = new THREE.Mesh(geo, mat);
        kue.position.y = scale * 0.15;
        kueData.group.add(kue);
        const glazeGeo = geo.clone();
        const glazeMat = new THREE.MeshPhongMaterial({ color: kueData.warnaGlaze, transparent: true, opacity: 0.5 });
        const glaze = new THREE.Mesh(glazeGeo, glazeMat);
        glaze.position.y = scale * 0.16;
        kueData.group.add(glaze);
        kueData.group.position.set(0, 0, 0);
        kueData.group.scale.set(scale, scale, scale);
        if (!scene) throw new Error('Scene not initialized');
        scene.add(kueData.group);
        kueList.push(kueData);
        selectedKue = kueData;
        console.log('Kue added to scene at', kueData.group.position.toArray());
      } catch (e) {
        console.error('Create kue error:', e);
      }
    }

    function addTopping(type, point) {
      if (!selectedKue || !THREE) {
        console.error('No selected kue or THREE.js not available');
        return;
      }
      try {
        const localPoint = selectedKue.group.worldToLocal(point.clone());
        let geo, mat;
        if (type === 'taburanSprinkle') {
          geo = new THREE.SphereGeometry(0.03 * skalaTopping, 8, 8);
          mat = new THREE.MeshPhongMaterial({ color: warnaTopping });
        } else if (type === 'taburanChip') {
          geo = new THREE.BoxGeometry(0.04 * skalaTopping, 0.02 * skalaTopping, 0.04 * skalaTopping);
          mat = new THREE.MeshPhongMaterial({ color: warnaTopping });
        } else if (type === 'taburanBunga') {
          geo = new THREE.TetrahedronGeometry(0.04 * skalaTopping);
          mat = new THREE.MeshPhongMaterial({ color: warnaTopping });
        } else if (type === 'taburanBuah') {
          geo = new THREE.DodecahedronGeometry(0.04 * skalaTopping);
          mat = new THREE.MeshPhongMaterial({ color: warnaTopping });
        } else if (type === 'taburanKrim') {
          geo = new THREE.ConeGeometry(0.04 * skalaTopping, 0.08 * skalaTopping, 8);
          mat = new THREE.MeshPhongMaterial({ color: warnaTopping });
        }
        const topping = new THREE.Mesh(geo, mat);
        topping.position.copy(localPoint);
        topping.position.y += 0.15;
        selectedKue.group.add(topping);
        selectedKue.topping.push(topping);
        console.log(`${type} ditambahkan`);
      } catch (e) {
        console.error('Add topping error:', e);
      }
    }

    function addLilin(point) {
      if (!selectedKue || !THREE) {
        console.error('No selected kue or THREE.js not available');
        return;
      }
      try {
        const localPoint = selectedKue.group.worldToLocal(point.clone());
        const group = new THREE.Group();
        const candleGeo = new THREE.CylinderGeometry(0.02 * skalaLilin, 0.02 * skalaLilin, 0.1 * skalaLilin, 8);
        const candleMat = new THREE.MeshPhongMaterial({ color: warnaLilin });
        const candle = new THREE.Mesh(candleGeo, candleMat);
        candle.position.y = 0.05 * skalaLilin;
        group.add(candle);
        const flameGeo = new THREE.PlaneGeometry(0.03 * skalaLilin, 0.06 * skalaLilin);
        const flameMat = new THREE.MeshBasicMaterial({ map: createFlameTexture(), transparent: true, side: THREE.DoubleSide });
        const flame = new THREE.Mesh(flameGeo, flameMat);
        flame.position.y = 0.1 * skalaLilin;
        group.add(flame);
        group.position.copy(localPoint);
        group.position.y += 0.15;
        selectedKue.group.add(group);
        selectedKue.lilin.push(group);
        console.log('Lilin ditambahkan');
      } catch (e) {
        console.error('Add lilin error:', e);
      }
    }

    function addCairan(point) {
      if (!selectedKue || !THREE) {
        console.error('No selected kue or THREE.js not available');
        return;
      }
      try {
        const localPoint = selectedKue.group.worldToLocal(point.clone());
        const geo = new THREE.PlaneGeometry(0.2, 0.2);
        const mat = createLiquidShader();
        if (mat) {
          mat.uniforms.color.value.set(warnaCairan);
          mat.uniforms.intensitas.value = intensitasCairan;
          const cairan = new THREE.Mesh(geo, mat);
          cairan.position.copy(localPoint);
          cairan.position.y += 0.16;
          cairan.rotation.x = -Math.PI / 2;
          selectedKue.group.add(cairan);
          selectedKue.cairan.push(cairan);
          console.log('Cairan ditambahkan');
        }
      } catch (e) {
        console.error('Add cairan error:', e);
      }
    }

    function addText(point, text = 'HBD') {
      if (!selectedKue || !THREE) {
        console.error('No selected kue or THREE.js not available');
        return;
      }
      try {
        const localPoint = selectedKue.group.worldToLocal(point.clone());
        const loader = new THREE.FontLoader();
        loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', (font) => {
          const geo = new THREE.TextGeometry(text, { font: font, size: 0.1, height: 0.02 });
          const mat = new THREE.MeshPhongMaterial({ color: 0xffffff });
          const textMesh = new THREE.Mesh(geo, mat);
          textMesh.position.copy(localPoint);
          textMesh.position.y += 0.15;
          selectedKue.group.add(textMesh);
          selectedKue.teks.push(textMesh);
          console.log('Teks ditambahkan');
        }, undefined, (err) => console.error('Font load error:', err));
      } catch (e) {
        console.error('Add text error:', e);
      }
    }

    function addEmoticon(point) {
      if (!selectedKue || !THREE) {
        console.error('No selected kue or THREE.js not available');
        return;
      }
      try {
        const localPoint = selectedKue.group.worldToLocal(point.clone());
        const geo = new THREE.PlaneGeometry(0.1, 0.1);
        const mat = new THREE.MeshBasicMaterial({ color: 0xffff00, transparent: true });
        const emoticon = new THREE.Mesh(geo, mat);
        emoticon.position.copy(localPoint);
        emoticon.position.y += 0.15;
        selectedKue.group.add(emoticon);
        selectedKue.emoticon.push(emoticon);
        console.log('Emoticon ditambahkan');
      } catch (e) {
        console.error('Add emoticon error:', e);
      }
    }

    function removeDecoration(obj) {
      if (!selectedKue || !THREE) {
        console.error('No selected kue or THREE.js not available');
        return;
      }
      try {
        selectedKue.group.remove(obj);
        selectedKue.topping = selectedKue.topping.filter(t => t !== obj);
        selectedKue.lilin = selectedKue.lilin.filter(l => l !== obj);
        selectedKue.cairan = selectedKue.cairan.filter(c => c !== obj);
        selectedKue.teks = selectedKue.teks.filter(t => t !== obj);
        selectedKue.emoticon = selectedKue.emoticon.filter(e => e !== obj);
        console.log('Dekorasi dihapus');
      } catch (e) {
        console.error('Remove decoration error:', e);
      }
    }

    function saveKue() {
      try {
        const kueData = kueList.map(k => ({
          bentuk: k.bentuk,
          warnaKue: k.warnaKue,
          warnaGlaze: k.warnaGlaze,
          teksturKue: k.teksturKue,
          topping: k.topping.map(t => ({ position: t.position.toArray(), type: t.geometry.type, color: t.material.color.getHex() })),
          lilin: k.lilin.map(l => ({ position: l.position.toArray() })),
          cairan: k.cairan.map(c => ({ position: c.position.toArray() })),
          teks: k.teks.map(t => ({ position: t.position.toArray() })),
          emoticon: k.emoticon.map(e => ({ position: e.position.toArray() }))
        }));
        localStorage.setItem('kueData', JSON.stringify(kueData));
        console.log('Kue disimpan');
      } catch (e) {
        console.error('Save kue error:', e);
      }
    }

    function loadKue() {
      try {
        const data = localStorage.getItem('kueData');
        if (!data) return;
        const kueData = JSON.parse(data);
        kueList.forEach(k => scene.remove(k.group));
        kueList = [];
        kueData.forEach(k => {
          createKue(k.bentuk, 'sedang', k.teksturKue, k.warnaKue);
          k.topping.forEach(t => {
            const point = new THREE.Vector3(...t.position);
            addTopping(t.type === 'SphereGeometry' ? 'taburanSprinkle' : 
                       t.type === 'BoxGeometry' ? 'taburanChip' : 
                       t.type === 'TetrahedronGeometry' ? 'taburanBunga' : 
                       t.type === 'DodecahedronGeometry' ? 'taburanBuah' : 'taburanKrim', point);
          });
        });
        console.log('Kue diload');
      } catch (e) {
        console.error('Load kue error:', e);
      }
    }

    function handleNavigation() {
      let halamanSekarang = 1;
      document.getElementById('tombolLanjut1').addEventListener('click', () => {
        document.getElementById(`halaman${halamanSekarang}`).classList.add('sembunyi');
        halamanSekarang++;
        document.getElementById(`halaman${halamanSekarang}`).classList.remove('sembunyi');
        confetti({ particleCount: 50, spread: 70 });
      });
      document.getElementById('tombolLanjut2').addEventListener('click', () => {
        document.getElementById(`halaman${halamanSekarang}`).classList.add('sembunyi');
        halamanSekarang++;
        document.getElementById(`halaman${halamanSekarang}`).classList.remove('sembunyi');
      });
      document.getElementById('tombolMulai').addEventListener('click', () => {
        document.getElementById('halaman3').classList.add('sembunyi');
        document.getElementById('halamanPermainan').classList.remove('sembunyi');
        document.getElementById('instruksiPopup').style.display = 'block';
      });
      document.getElementById('tombolMulaiGame').addEventListener('click', () => {
        document.getElementById('instruksiPopup').style.display = 'none';
        const bgMusic = document.getElementById('bgMusic');
        setTimeout(() => {
          bgMusic.play().then(() => {
            isMusicPlaying = true;
            document.getElementById('toggleMusic').textContent = '🔊';
            console.log('Audio started');
          }).catch(e => {
            console.error('Audio play failed:', e);
            document.getElementById('toggleMusic').textContent = '🔇';
          });
        }, 100);
      });
    }

    document.getElementById('toggleMusic').addEventListener('click', () => {
      const bgMusic = document.getElementById('bgMusic');
      if (isMusicPlaying) {
        bgMusic.pause();
        document.getElementById('toggleMusic').textContent = '🔇';
        isMusicPlaying = false;
      } else {
        bgMusic.play().then(() => {
          document.getElementById('toggleMusic').textContent = '🔊';
          isMusicPlaying = true;
        }).catch(e => console.error('Audio play failed:', e));
      }
    });

    document.getElementById('buatKue').addEventListener('click', () => {
      const bentuk = document.getElementById('bentukKue').value;
      const ukuran = document.getElementById('ukuranKue').value;
      const tekstur = document.getElementById('teksturKue').value;
      const warna = parseInt(document.getElementById('warnaKue').value.replace('#', '0x'));
      createKue(bentuk, ukuran, tekstur, warna);
    });

    document.getElementById('hapusKue').addEventListener('click', () => {
      if (selectedKue) {
        scene.remove(selectedKue.group);
        kueList = kueList.filter(k => k !== selectedKue);
        selectedKue = kueList.length > 0 ? kueList[kueList.length - 1] : null;
        console.log('Kue dihapus');
      }
    });

    document.getElementById('teksturKue').addEventListener('change', (e) => {
      if (selectedKue && THREE) {
        selectedKue.teksturKue = e.target.value;
        const texture = createKueTexture(selectedKue.teksturKue);
        const bump = createBumpMap(selectedKue.teksturKue);
        selectedKue.group.children[0].material.map = texture;
        selectedKue.group.children[0].material.bumpMap = bump;
        selectedKue.group.children[0].material.needsUpdate = true;
        console.log('Tekstur kue diubah:', selectedKue.teksturKue);
      }
    });

    document.getElementById('taburanSprinkle').addEventListener('click', () => {
      dekorasiTerpilih = 'taburanSprinkle';
      isMoving = false;
      console.log('Dekorasi dipilih: Sprinkle');
    });

    document.getElementById('taburanChip').addEventListener('click', () => {
      dekorasiTerpilih = 'taburanChip';
      isMoving = false;
      console.log('Dekorasi dipilih: Chip');
    });

    document.getElementById('taburanBunga').addEventListener('click', () => {
      dekorasiTerpilih = 'taburanBunga';
      isMoving = false;
      console.log('Dekorasi dipilih: Bunga');
    });

    document.getElementById('taburanBuah').addEventListener('click', () => {
      dekorasiTerpilih = 'taburanBuah';
      isMoving = false;
      console.log('Dekorasi dipilih: Buah');
    });

    document.getElementById('taburanKrim').addEventListener('click', () => {
      dekorasiTerpilih = 'taburanKrim';
      isMoving = false;
      console.log('Dekorasi dipilih: Krim');
    });

    document.getElementById('warnaTopping').addEventListener('input', (e) => {
      warnaTopping = parseInt(e.target.value.replace('#', '0x'));
      console.log('Warna topping:', warnaTopping);
    });

    document.getElementById('skalaTopping').addEventListener('input', (e) => {
      skalaTopping = parseFloat(e.target.value);
      console.log('Skala topping:', skalaTopping);
    });

    document.getElementById('lilin').addEventListener('click', () => {
      dekorasiTerpilih = 'lilin';
      isMoving = false;
      console.log('Dekorasi dipilih: Lilin');
    });

    document.getElementById('warnaLilin').addEventListener('input', (e) => {
      warnaLilin = parseInt(e.target.value.replace('#', '0x'));
      console.log('Warna lilin:', warnaLilin);
    });

    document.getElementById('skalaLilin').addEventListener('input', (e) => {
      skalaLilin = parseFloat(e.target.value);
      console.log('Skala lilin:', skalaLilin);
    });

    document.getElementById('cairan').addEventListener('click', () => {
      dekorasiTerpilih = 'cairan';
      isMoving = false;
      console.log('Dekorasi dipilih: Cairan');
    });

    document.getElementById('warnaCairan').addEventListener('input', (e) => {
      warnaCairan = parseInt(e.target.value.replace('#', '0x'));
      console.log('Warna cairan:', warnaCairan);
    });

    document.getElementById('intensitasCairan').addEventListener('input', (e) => {
      intensitasCairan = parseFloat(e.target.value);
      console.log('Intensitas cairan:', intensitasCairan);
    });

    document.getElementById('tambahTeks').addEventListener('click', () => {
      dekorasiTerpilih = 'teks';
      isMoving = false;
      console.log('Dekorasi dipilih: Teks');
    });

    document.getElementById('tambahEmoticon').addEventListener('click', () => {
      dekorasiTerpilih = 'emoticon';
      isMoving = false;
      console.log('Dekorasi dipilih: Emoticon');
    });

    document.getElementById('pindahObjek').addEventListener('click', () => {
      if (selectedKue) {
        isMoving = true;
        isDragging = false;
        controls.enabled = false;
        console.log('Mode pindah objek aktif');
      }
    });

    document.getElementById('hapusObjek').addEventListener('click', () => {
      if (selectedKue && dekorasiTerpilih) {
        removeDecoration(selectedKue.group.children[selectedKue.group.children.length - 1]);
      }
    });

    document.getElementById('simpanKue').addEventListener('click', saveKue);
    document.getElementById('loadKue').addEventListener('click', loadKue);

    document.getElementById('selesai').addEventListener('click', () => {
      if (permainanSelesai) return;
      permainanSelesai = true;
      let detail = 'Detail Kue Kamu:\n';
      kueList.forEach((kue, index) => {
        detail += `Kue ${index + 1}: ${kue.bentuk}, Tekstur: ${kue.teksturKue}, Topping: ${kue.topping.length}, Lilin: ${kue.lilin.length}, Cairan: ${kue.cairan.length}, Teks: ${kue.teks.length}, Emoji: ${kue.emoticon.length}\n`;
      });
      document.getElementById('detailText').textContent = detail;
      document.getElementById('detailPopup').style.display = 'block';
      confetti({ particleCount: 200, spread: 90, colors: ['#ff5555', '#55ff55', '#55ffff'] });
      console.log('Permainan selesai');
    });

    document.getElementById('tombolLanjutDetail').addEventListener('click', () => {
      document.getElementById('detailPopup').style.display = 'none';
      document.getElementById('pesanPopup').style.display = 'block';
      confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#ff69b4', '#ffff00'] });
    });

    document.getElementById('tombolUlang').addEventListener('click', () => {
      window.location.reload();
      console.log('Permainan diulang');
    });

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    document.getElementById('kanvasPermainan').addEventListener('mousedown', (e) => {
      if (!THREE) {
        console.error('THREE.js not available');
        return;
      }
      e.preventDefault();
      mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(kueList.map(k => k.group.children[0]));
      if (intersects.length > 0 && dekorasiTerpilih) {
        const point = intersects[0].point;
        if (dekorasiTerpilih === 'taburanSprinkle') addTopping('taburanSprinkle', point);
        else if (dekorasiTerpilih === 'taburanChip') addTopping('taburanChip', point);
        else if (dekorasiTerpilih === 'taburanBunga') addTopping('taburanBunga', point);
        else if (dekorasiTerpilih === 'taburanBuah') addTopping('taburanBuah', point);
        else if (dekorasiTerpilih === 'taburanKrim') addTopping('taburanKrim', point);
        else if (dekorasiTerpilih === 'lilin') addLilin(point);
        else if (dekorasiTerpilih === 'cairan') addCairan(point);
        else if (dekorasiTerpilih === 'teks') addText(point);
        else if (dekorasiTerpilih === 'emoticon') addEmoticon(point);
      }
    });

    document.getElementById('tambahDekorasi').addEventListener('click', () => {
      const panel = document.getElementById('panelDekorasi');
      panel.classList.toggle('sembunyi');
      panel.classList.toggle('open');
      document.getElementById('tambahDekorasi').textContent = panel.classList.contains('open') ? '❌' : '🎨';
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    let time = 0;
    function render() {
      if (!THREE || !scene || !camera || !renderer) {
        console.error('Render skipped: THREE.js, scene, camera, or renderer not initialized');
        return;
      }
      try {
        if (permainanSelesai && selectedKue) {
          selectedKue.group.rotation.y += 0.01;
          camera.position.lerp(new THREE.Vector3(0, 1, 1.5), 0.05);
          controls.enabled = false;
        } else {
          controls.update();
        }
        kueList.forEach(kue => {
          kue.cairan.forEach(c => {
            if (c.material && c.material.uniforms) {
              c.material.uniforms.time.value = time;
            }
          });
        });
        time += 0.02;
        renderer.render(scene, camera);
        requestAnimationFrame(render);
      } catch (e) {
        console.error('Render error:', e);
      }
    }

    window.addEventListener('resize', () => {
      if (!THREE || !camera || !renderer) {
        console.error('Resize skipped: THREE.js, camera, or renderer not initialized');
        return;
      }
      try {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      } catch (e) {
        console.error('Resize error:', e);
      }
    });

    // Inisialisasi
    try {
      console.log('Initializing...');
      if (!navigator.onLine) {
        alert('Kamu offline! CDN THREE.js butuh internet. Pastikan koneksi aktif.');
        throw new Error('Offline mode detected');
      }
      setupScene();
      handleNavigation();
      render();
      console.log('Initialization completed');
    } catch (e) {
      console.error('Initialization error:', e);
      alert('Gagal inisialisasi game! Cek Console (F12) untuk detail. Pastikan koneksi internet aktif.');
    }
  </script>
</body>
</html>
